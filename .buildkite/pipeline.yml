.test: &test
  if: build.env("DAGGER_BENCHMARK") != "true"
  agents:
    queue: "juliaecosystem"
    sandbox.jl: "true"
steps:
  - label: Julia 1.6
    timeout_in_minutes: 60
    <<: *test
    plugins:
      - JuliaCI/julia#v1:
          version: "1.6"
      - JuliaCI/julia-test#v1:
          julia_args: "--threads=1"
      # - JuliaCI/julia-coverage#v1:
      #     codecov: true
  - label: Julia 1.7
    timeout_in_minutes: 60
    <<: *test
    plugins:
      - JuliaCI/julia#v1:
          version: "1.7"
      - JuliaCI/julia-test#v1:
          julia_args: "--threads=1"
      # - JuliaCI/julia-coverage#v1:
      #     codecov: true
  - label: Julia nightly
    timeout_in_minutes: 60
    <<: *test
    plugins:
      - JuliaCI/julia#v1:
          version: "1.8-nightly"
      - JuliaCI/julia-test#v1:
          julia_args: "--threads=1"
      # - JuliaCI/julia-coverage#v1:
      #     codecov: true
  - label: DaggerFlux Reverse CI
    agents:
      queue: "juliagpu"
      rocm: "*"
    timeout_in_minutes: 60
    plugins:
      - JuliaCI/julia#v1:
          version: "1.6"
      # - JuliaCI/julia-coverage#v1:
      #     codecov: true
    command: echo Testing 123
  - label: Benchmarks
    command: echo TODO
    if: build.env("DAGGER_BENCHMARK") == "true"
    agents:
      os: linux
      arch: x86_64
      serial: true
    plugins:
      - docker#v3.7.0:
          image: julia:1.7.2
    artifacts:
      - benchmarks/TODO
