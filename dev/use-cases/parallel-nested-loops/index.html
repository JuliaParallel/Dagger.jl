<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Parallel Nested Loops · Dagger.jl</title><meta name="title" content="Parallel Nested Loops · Dagger.jl"/><meta property="og:title" content="Parallel Nested Loops · Dagger.jl"/><meta property="twitter:title" content="Parallel Nested Loops · Dagger.jl"/><meta name="description" content="Documentation for Dagger.jl."/><meta property="og:description" content="Documentation for Dagger.jl."/><meta property="twitter:description" content="Documentation for Dagger.jl."/><meta property="og:url" content="https://JuliaParallel.github.io/Dagger.jl/use-cases/parallel-nested-loops/"/><meta property="twitter:url" content="https://JuliaParallel.github.io/Dagger.jl/use-cases/parallel-nested-loops/"/><link rel="canonical" href="https://JuliaParallel.github.io/Dagger.jl/use-cases/parallel-nested-loops/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="Dagger.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Dagger.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Use Cases</span><ul><li class="is-active"><a class="tocitem" href>Parallel Nested Loops</a></li></ul></li><li><a class="tocitem" href="../../task-spawning/">Task Spawning</a></li><li><a class="tocitem" href="../../data-management/">Data Management</a></li><li><a class="tocitem" href="../../darray/">Distributed Arrays</a></li><li><a class="tocitem" href="../../scopes/">Scopes</a></li><li><a class="tocitem" href="../../processors/">Processors</a></li><li><a class="tocitem" href="../../task-queues/">Task Queues</a></li><li><a class="tocitem" href="../../datadeps/">Datadeps</a></li><li><a class="tocitem" href="../../propagation/">Option Propagation</a></li><li><span class="tocitem">Logging and Visualization</span><ul><li><a class="tocitem" href="../../logging/">Logging: Basics</a></li><li><a class="tocitem" href="../../logging-visualization/">Logging: Visualization</a></li><li><a class="tocitem" href="../../logging-advanced/">Logging: Advanced</a></li></ul></li><li><a class="tocitem" href="../../checkpointing/">Checkpointing</a></li><li><a class="tocitem" href="../../benchmarking/">Benchmarking</a></li><li><a class="tocitem" href="../../dynamic/">Dynamic Scheduler Control</a></li><li><a class="tocitem" href="../../scheduler-internals/">Scheduler Internals</a></li><li><span class="tocitem">Dagger API</span><ul><li><a class="tocitem" href="../../api-dagger/types/">Types</a></li><li><a class="tocitem" href="../../api-dagger/functions/">Functions and Macros</a></li></ul></li><li><span class="tocitem">TimespanLogging API</span><ul><li><a class="tocitem" href="../../api-timespanlogging/types/">Types</a></li><li><a class="tocitem" href="../../api-timespanlogging/functions/">Functions and Macros</a></li></ul></li><li><span class="tocitem">DaggerWebDash API</span><ul><li><a class="tocitem" href="../../api-daggerwebdash/types/">Types</a></li><li><a class="tocitem" href="../../api-daggerwebdash/functions/">Functions and Macros</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Use Cases</a></li><li class="is-active"><a href>Parallel Nested Loops</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Parallel Nested Loops</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaParallel/Dagger.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaParallel/Dagger.jl/blob/master/docs/src/use-cases/parallel-nested-loops.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Use-Case:-Parallel-Nested-Loops"><a class="docs-heading-anchor" href="#Use-Case:-Parallel-Nested-Loops">Use Case: Parallel Nested Loops</a><a id="Use-Case:-Parallel-Nested-Loops-1"></a><a class="docs-heading-anchor-permalink" href="#Use-Case:-Parallel-Nested-Loops" title="Permalink"></a></h1><p>One of the many applications of Dagger is that it can be used as a drop-in replacement for nested multi-threaded loops that would otherwise be written with <code>Threads.@threads</code>.</p><p>Consider a simplified scenario where you want to calculate the maximum mean values of random samples of various lengths that have been generated by several distributions provided by the Distributions.jl package. The results should be collected into a DataFrame. We have the following function:</p><pre><code class="language-julia hljs">using Dagger, Random, Distributions, StatsBase, DataFrames

function f(dist, len, reps, σ)
    v = Vector{Float64}(undef, len) # avoiding allocations
    maximum(mean(rand!(dist, v)) for _ in 1:reps)/σ
end</code></pre><p>Let us consider the following probability distributions for numerical experiments, all of which have expected values equal to zero, and the following lengths of vectors:</p><pre><code class="language-julia hljs">dists =  [Cosine, Epanechnikov, Laplace, Logistic, Normal, NormalCanon, PGeneralizedGaussian, SkewNormal, SkewedExponentialPower, SymTriangularDist]
lens = [10, 20, 50, 100, 200, 500]</code></pre><p>Using <code>Threads.@threads</code> those experiments could be parallelized as:</p><pre><code class="language-julia hljs">function experiments_threads(dists, lens, K=1000)
    res = DataFrame()
    lck = ReentrantLock()
    Threads.@threads for T in dists
        dist = T()
        σ = std(dist)
        for L in lens
            z = f(dist, L, K, σ)
            Threads.lock(lck) do
                push!(res, (;T, σ, L, z))
            end
        end
    end
    res
end</code></pre><p>Note that <code>DataFrames.push!</code> is not a thread safe operation and hence we need to utilize a locking mechanism in order to avoid two threads appending the DataFrame at the same time.</p><p>The same code could be rewritten in Dagger as:</p><pre><code class="language-julia hljs">function experiments_dagger(dists, lens, K=1000)
    res = DataFrame()
    @sync for T in dists
        dist = T()
        σ = Dagger.@spawn std(dist)
        for L in lens
            z = Dagger.@spawn f(dist, L, K, σ)
            push!(res, (;T, σ, L, z))
        end
    end
    res.z = fetch.(res.z)
    res.σ = fetch.(res.σ)
    res
end</code></pre><p>In this code we have job interdependence. Firstly, we are calculating the standard deviation <code>σ</code>, and then we are using that value in the function <code>f</code>. Since <code>Dagger.@spawn</code> yields a <code>DTask</code> rather than actual values, we need to use the <code>fetch</code> function to obtain those values. In this example, the value fetching is performed once all computations are completed (note that <code>@sync</code> preceding the loop forces the loop to wait for all jobs to complete). Also, note that contrary to the previous example, we do not need to implement locking as we are just pushing the <code>DTask</code> results of <code>Dagger.@spawn</code> serially into the DataFrame (which is fast since <code>Dagger.@spawn</code> doesn&#39;t block).</p><p>The above use case scenario has been tested by running <code>julia -t 8</code> (or with <code>JULIA_NUM_THREADS=8</code> as environment variable). The <code>Threads.@threads</code> code takes 1.8 seconds to run, while the Dagger code, which is also one line shorter, runs around 0.9 seconds, resulting in a 2x speedup.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Annotating an inner loop with <code>@sync</code> will block the outer loop from iterating until the inner <code>@sync</code> loop is fully completed, negating some potential parallelism. <code>@sync</code> should only be applied to the outermost loop before a <code>fetch</code>.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../">« Home</a><a class="docs-footer-nextpage" href="../../task-spawning/">Task Spawning »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.0 on <span class="colophon-date" title="Thursday 29 August 2024 19:38">Thursday 29 August 2024</span>. Using Julia version 1.10.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
